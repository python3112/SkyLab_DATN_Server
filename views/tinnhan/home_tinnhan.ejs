<!DOCTYPE html>
<html>

<head>
  <title>
    <%= title %>
  </title>
  <link rel='stylesheet' href='../stylesheets/style_header.css' />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

  <style>
    .message-container {
      width: 100%;
      display: flex;
    }

    /* phần csss tìm kiếm và check  */
    .search_and_check {
      width: 25%;
      height: 100%;
      margin-top: 10px;
      margin-left: 10px;
      margin-right: 10px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);

    }

    .search_mess {
      width: 95%;
      margin-left: 2.5%;
      height: 40px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid black;

    }

    .search_mess input:focus {

      outline: none;
      border: none;
    }

    .btn_search {
      width: 20%;
      height: 100%;
      border: #F1F0F0;
      background-color: white;
    }

    .icon_btn {
      padding: 5px;
      border: none;
      border-right: 1px solid black;
    }

    .icon_btn:hover {
      padding: 10px;
    }

    .btn_all {
      border: none;
      border-radius: 20px;
      width: 45%;
      background-color: white;

    }

    .btn_not_seen {
      border: none;
      border-radius: 20px;
      width: 45%;
      background-color: white;

    }


    .item_chat {
      width: 95%;
      margin-top: 10px;
      align-self: center;
      margin-left: 2.5%;
      display: flex;
      align-items: center;
      border-radius: 15px;
      border: 1px solid #ddd;
      /* Thêm đường viền để tạo độ sâu */
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      /* Shadow mềm mại */
      transition: box-shadow 0.3s ease;
    }

    .item_chat:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .item_chat:focus {
      padding: 20px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .item_chat_contentMess {
      font-size: 12px;
      margin-left: 5px;
    }

    /* ////////// ////// */

    /* ///// chat .chat_frame */
    .chat_frame {
      width: 70%;
      border-radius: 10px;
      flex-direction: column;
      height: 750px;
      margin-top: 20px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .header_chat_frame {
      margin-top: 10px;
      margin-left: 20px;
      width: 100%;
      height: 10%;
      border-bottom: 1px solid black;

    }

    .name_user_Chatframe {
      margin-left: 10px;
      font-size: 20px;
    }

    .body_chat_frame {
      width: 95%;
      margin-left: 2.5%;
      height: 80%;
    }

    .bottom_chat_frame {
      width: 90%;
      margin-left: 2.5%;
    }

    .message_wrapper {
      display: flex;
      align-items: center;
      margin-top: 10px;
      margin-bottom: 10px;
      /* Khoảng cách giữa các tin nhắn */
    }



    /* ///////////////////////// */

    .message {
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
    }



    .message img {
      max-width: 100%;
      border-radius: 10px;
    }

    .highlighted {
      border: 1px solid black;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
      transition: box-shadow 0.3s ease;
      /* Thiết lập viền cho các nút được chọn */
    }

    .left-message {
      width: fit-content;
      padding: 10px;
      color: white;
      background-color: #ccc;
      /* Màu xám */
      max-width: 400px;
      margin-left: 10px;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      border-bottom-right-radius: 10px;

    }

    .right-message {
      padding: 10px;
      background-color: #3cb371;
      /* Màu xanh */
      max-width: 300px;
    }

    .avata {
      border-radius: 50px;
      margin-top: 30px;
      width: 50px;
      height: 50px;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Gọi hàm highlightButton khi DOM đã được tải
      highlightButton('btn_all');


    });
    function highlightButton(buttonId) {
      var buttons = document.querySelectorAll('.check_chat button');
      // Chọn tất cả các nút trong phần check_chat

      buttons.forEach(function (btn) {
        btn.classList.remove('highlighted'); // Loại bỏ lớp 'highlighted' từ tất cả các nút
      });
      var button = document.querySelector('.' + buttonId);
      button.classList.add('highlighted');  // Thêm lớp 'highlighted' vào nút được nhấn
    }

    function item_chatOnclick(srcImg, nameAcc, idChat, idAccount) {
      var imgAvata = document.getElementById('img_avata_user_Chatframe');
      var nameUser = document.getElementById('name_user_Chatframe');
      if (srcImg == "") {

      } else {
        imgAvata.src = srcImg;
      }
      nameUser.innerHTML = nameAcc;
      window.data_ChatFrame(idChat, idAccount, srcImg)
    }


  </script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js'
    // If you enabled Analytics in your project, add the Firebase SDK for Google Analytics
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-analytics.js'

    // Add Firebase products that you want to use
    import { getAuth } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js'
    import { getDatabase, ref, push, set, onValue, equalTo, orderByChild, orderByKey, query } from 'https://www.gstatic.com/firebasejs/10.10.0/firebase-database.js'
    const firebaseConfig = {
      apiKey: "AIzaSyAQTaVbsAvnb1KWVl1HlhoOum8YwcbEbZE",
      authDomain: "skylap-md03.firebaseapp.com",
      databaseURL: "https://skylap-md03-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "skylap-md03",
      storageBucket: "skylap-md03.appspot.com",
      messagingSenderId: "206926809191",
      appId: "1:206926809191:web:e8dc6a3da11ea129b4ecc2",
      measurementId: "G-TSY3SXB2F5"
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const data = ref(database, '/Chat');

    window.data_ChatFrame = function (idChat, idAccount, srcImg) {
      const body_chat_frame = document.getElementById('body_chat_frame');
      const dataMess = ref(database, '/messages');
      const querymess = query(dataMess, orderByChild('idChat'), equalTo(idChat))
      onValue(querymess, (snapshot) => {
        const messagesArray = snapshot.val(); // Lấy giá trị trả về từ snapshot
        if (messagesArray) {
          body_chat_frame.removeChild(body_chat_frame.firstChild);
          const messageContainer = document.createElement('div');
          messageContainer.classList.add('item_message_frame');
          const messages = Object.values(messagesArray);
          messages.forEach(message => {
            console.log(message);
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message_wrapper') // Tạo một div mới để bao gồm mỗi cặp img và message
            const messageElement = document.createElement('div');
            const imgElement = document.createElement('img');
            messageElement.innerText = message.content;
            if (message.idAccount === idAccount) {
              if (srcImg === "") {
                imgElement.classList.add('avata');
                messageElement.classList.add('left-message');
                imgElement.src = 'https://cdn-icons-png.flaticon.com/128/3135/3135715.png';
              } else {
                imgElement.classList.add('avata');
                messageElement.classList.add('left-message');
                imgElement.src = srcImg;
              }
            } else {
              imgElement.classList.add('avata_admin');
              messageElement.classList.add('right-message');
              imgElement.src = 'https://cdn-icons-png.flaticon.com/128/6024/6024190.png';
            }
            messageWrapper.appendChild(imgElement); // Thêm img vào div mới
            messageWrapper.appendChild(messageElement); // Thêm message vào div mới
            messageContainer.appendChild(messageWrapper); // Thêm div mới vào container chứa tin nhắn
          });
          body_chat_frame.appendChild(messageContainer);
        } else {
          console.log('No messages found');
        }
      });
    }





  </script>

</head>

<body>
  <%- include('../inc/header') %>
    <div class="d-flex flex-row">
      <%- include('../inc/sidebar') %>
        <div class="message-container">


          <div class="search_and_check">
            <div class="search_mess">
              <button class="btn_search" type="button">
                <img class="icon_btn" width="40" height="40" src="https://cdn-icons-png.flaticon.com/128/954/954591.png"
                  alt="search_mess" srcset="">
              </button>
              <input placeholder="Tìm Kiếm " style="border: white; height: 30px; width: 75%; " type="text">

            </div>

            <!-- chon chưa đọc và tất cả  -->
            <div class="check_chat" style="margin-top: 10px; width: 100%; align-items: center;">
              <button class="btn_all" type="submit" onclick="highlightButton('btn_all')">Tất cả </button>
              <button class="btn_not_seen" type="submit" onclick="highlightButton('btn_not_seen')"
                style="border-radius: 20px; width: 48%;">Chưa đọc </button>
            </div>

            <!-- /////////////////////// -->


            <div class="list_chat" style="max-height: max-content; width: 100%; overflow-x: auto;">
              <% if (listAccounts==null) { %>

                <% } else { %>
                  <% listAccounts.forEach(account=> { %>
                    <% listMess.forEach(message=> { %>
                      <% if (account) { %>
                        <% if (message.idAccount == account._id ) { %>
                          <div class="item_chat"
                            onclick="item_chatOnclick('<%= account.avatar %>', '<%= account.taiKhoan %>', '<%= message.idChat %>' ,'<%= account._id %>'  )">
                            <% if (account.avatar) { %>
                              <img style="border-radius: 30px; margin-left: 10px;" width="50" height="50"
                                src="<%= account.avatar %>">
                              <% } else { %>
                                <img style="border-radius: 30px; margin-left: 10px;" width="50" height="50"
                                  src="https://cdn-icons-png.flaticon.com/128/3135/3135715.png">
                                <% } %>
                                  <div style="margin-left: 10px; margin-top: 5px;">
                                    <% if (account.taiKhoan) { %>
                                      <p>
                                        <%= account.taiKhoan %>
                                      </p>
                                      <% } %>
                                        <% if (message.idAccount==account._id) { %>
                                          <strong class="item_chat_contentMess">
                                            <%= message.content %>
                                          </strong>
                                          <% } %>

                                  </div>
                          </div>
                          <% } %>
                            <% } %>
                              <% }); %>
                                <% }); %>
                                  <% } %>



            </div>
          </div>
          <div id="chat_frame" class="chat_frame">
            <div id="header_chat_frame" class="header_chat_frame">
              <img id="img_avata_user_Chatframe" src="https://cdn-icons-png.flaticon.com/128/3135/3135715.png"
                width="70" height="70" alt="" srcset="">
              <strong id="name_user_Chatframe" class="name_user_Chatframe">Vũ Huy Hoàng</strong>
            </div>
            <div id="body_chat_frame" class="body_chat_frame">
            </div>
            <div id="bottom_chat_frame" class="bottom_chat_frame">

            </div>

          </div>


        </div>





    </div>



    <%- include('../inc/footer') %>
</body>


</html>